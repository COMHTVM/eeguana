---
title: "Preprocessing and analysis of a simple N400 experiment"
author: "Bruno Nicenboim"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preprocessing and analysis of a simple N400 experiment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(10,15),
  out.width = "100%"
)
```



## Dataset

The EEG dataset and the script used here is available in [](). In this small experiment, participants (technicians of our lab) read sentences from [Metzner et al. 2015]( https://doi.org/10.1162/jocn_a_00731) such as the following one:

a. Paris ist die Hauptstadt von	Frankreich.

   **Paris is the capital of France.**
   
b. Rom ist die Hauptstadt von Frankreich.

   **Rome is the capital of France.**

And then answer whether they agreed with the statement.

...


The experiment uses the following triggers:
* Session starts: 5
* Instructions start: 101
* Practice starts: 111
* Experiment starts: 121
* Trial starts (fixation cross appears): 130
* Sentence ends: 132
* Question starts: 133
* Answer is given: 134
* Pause:135
* Experiment ends: 122
* Session ends: 102


## Preprocessing

First we load the `eeguana` and other packages that we'll use.

```{r}
library(dplyr)
library(ggplot2)
library(eeguana)
require(osfr)
set.seed(123) #ICA will always find the same components
```

We'll need the following dataset that can be downloaded from the folder N400 of [https://osf.io/tbwvz/]. Alternatively we could use `osfr` as follows:
```{r downloading}
files <- c("s1_N400.eeg","s1_N400.vmrk","s1_N400.vhdr")
```


The function `read_vhdr()` creates a list with tables for the signal, events, and
segments, and incorporates in its attributes generic EEG information. We can print this object, and also inspect the information about the channels  using `channels_tbl`

```{r}
s1_N400 <- read_vhdr(file = "N4data/s1_N400.vhdr")
s1_N400
channels_tbl(s1_N400)
```

There are two issues, there are repeated channels (HEOG.1 and VEOG.1), and there is no electrode positions in the object. First, we'll remove the extra channels using the function `select()` from `dplyr` overloaded to be used with `eeg_lst` objects. Then since we know that the layout was a standard 10/20, we'll add this layout to the object, using the dataset.


```{r}
s1_N400 <- s1_N400 %>% select(-HEOG.1, -VEOG.1)
## In case the order of the electrodes is different, we do a left_join instead of replacing the table:
channels_tbl(s1_N400) <- select(channels_tbl(s1_N400), .channel) %>%
    left_join(layout_32_1020)
```

## Pre-processing

### Rereferencing
In this dataset, the signal from all electrodes is monopolar and referenced to the left mastoid (M1). We want the signal (excluding the EOG channels) to be referenced to linked (left and right) mastoids (M1 and M2).

```{r}
s1_N400 <- eeg_rereference(s1_N400, -VEOG, -HEOG, ref_ch = c("M1", "M2") )

```

## Filtering

We apply a band pass filter of 0.1 to 30 Hz to all the channels except the EOG channels, where we apply a stronger filter to be able to detect eye movements later. We don't segment yet, because discontinuities in the signal create artifacts on the edges.

```{r}
s1_N400_filt <- eeg_filt_band_pass(s1_N400,-HEOG, -VEOG, freq = c(.1,30)) %>%
    eeg_filt_band_pass(HEOG,VEOG, freq = c(1,10))
```


## ICA

We want to apply ICA to as much data as possible, but to "representative" data, that is part of the experiments and not when the participants are moving or reading the instructions. For the same reason, we want to the ignore "crazy" artifacts: regions with extreme amplitudes in the signal.

```{r}
s1_N400_ls <- eeg_segment(s1_N400_filt, description == "s130", end= description == "s132") %>%
    eeg_artif_minmax(threshold = 100,window = 200, unit = "ms")

bad_ids <- filter(events_tbl(s1_N400_ls), type == "artifact") %>%
    pull(.id) %>%
    unique

plot_artif <- filter(s1_N400_ls, .id %in% bad_ids[1:10]) %>% 
     plot(max_sample =2000) + facet_grid(.key~.id)

add_events_plot(plot_artif)

events_tbl(s1_N400_ls)
## By default will ignore artifacts
s1_N400_ica <- s1_N400_ls %>%
    eeg_ica( -HEOG, -VEOG, -M1, -M2, ignore = type == "artifact")

```

We can now check the different topographic plots of the ICAs. And their correlation with the EOG channels
```{r}
s1_N400_ica %>% plot_topo_ica() +
    facet_wrap(~.ICA)+
    annotate_head() + 
    geom_contour() +
    geom_text(colour = "black")

summary(s1_N400_ica)
```
We'll look closer at the ICA that are more likely to be related to eye movements, and we'll compare with signals that look like blinks and saccades:
```{r}
ICAs <- c("ICA1", "ICA2","ICA3", "ICA17", "ICA29", "ICA7")
s1_N400_ica <- s1_N400_ica %>%
    eeg_artif_step(HEOG, threshold = 30, window=400, unit = "ms") %>%
    eeg_artif_minmax(VEOG, threshold = 50, window=200, unit = "ms")

blink_ids <- filter(events_tbl(s1_N400_ica), type == "artifact", .channel %in% c("VEOG","HEOG"))$.id %>% unique()


plot <- filter(s1_N400_ica, .id %in% blink_ids[1:20]) %>%
    eeg_ica_show(one_of(ICAs)) %>%
    select(c(ICAs, "VEOG", "HEOG")) %>%
    mutate_if(is_component_dbl, ~.*10) %>%
    plot( max_sample =2000) + facet_grid(.key~.id) +
    coord_cartesian(ylim=c(-50,50), xlim = c(0,4))

add_events_plot(plot, alpha =.3,all_chs = TRUE)

s1_N400_ica <- s1_N400_ica %>% eeg_ica_keep(-ICA1)


```

Now we'll segment the data to appropriate check if there are still artifacts.

```{r}

select(-description, -type) %>%
    eeg_segment(description %in% c("s10","s20"), lim = c(-.1,1))

s1_segs_artif <- s1_segs %>%
    eeg_artif_minmax(-HEOG, -VEOG, threshold =100, window=150, unit = "ms") %>%
    eeg_artif_step(-HEOG, -VEOG,threshold = 50, window=200, unit = "ms")

events_tbl(s1_segs_artif) %>% count(type,description)
ids <- events_tbl(s1_segs_artif) %>% filter(!is.na(.channel), !.channel %in% c("VEOG","HEOG")) %>%
    pull(.id)
plot_artif <- s1_segs_artif %>% filter(.id %in% ids) %>% plot() + facet_grid(.source ~segment)

add_events_plot(plot_artif)

```
