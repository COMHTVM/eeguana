---
output: github_document
---



```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
# eeguana

A package for flexible manipulation of EEG data. *eeguana* provides a framework for manipulating EEG data with *dplyr*-based functions (e.g., `mutate`, `filter`, `summarize`) extended to a new class `eeg_lst`. In addition, it provides other EEG-specialized functions, and `ggplot` wrapper functions.  The new class is inspired by tidyverse principles but it's not really "tidy" (due to space considerations), it's a list of (i) a wide table (`signal_tbl`) that contains the signal amplitudes at every sample point of the EEG,  (ii) an events table with information about markers (or triggers), blinks and other exported information, and (iii) a long table with experimental information, such as participant number (`recording`), conditions, etc.  

*eeguana* **cannot** pre-process data for now, but I plan to incorporate pre-processing functions with time, and thus it is meant to be used on EEG files where filtering, artifact rejection, ICA, etc have already been done.



## Installation

There is still **no** released version of *eeguana*.  The package is in the early stages of development, and it **will** be subject to a lot of changes. To install the latest version from github use:


``` r
devtools::install_github("bnicenboim/eeguana", build_vignettes = TRUE)

```

## Overview

The functions of *eeguana* can be roughly divided in the following groups:

### `read` functions

* `read_dat`
* `read_ft`

These functions read external files (BrainVision and mat files from Fieldtrip) and return an `eeg_lst`. (Upcoming: eeglab and edf files).

### Tidyverse `dplyr` functions

* `mutate*`
* `transmute*`
* `summarize*`
* `*_join`
* `select*`
* `rename*`
* `filter*`
* `group_by`
* `ungroup`
* `bind` &#9733;

These functions always return an `eeg_lst` and they should be straightforward to use. This is, if one is already used to `dplyr`, and if not, I would recommend to start from, for example, [R for Data Science](http://r4ds.had.co.nz/). (&#9733;: `bind` is not in `dplyr`, but it's inspired by `bind_*`).

### Specialized summarizing functions

* `summarize_by_id_tbl`
* `count_complete_cases_tbl`

These functions apply a series of `dplyr` functions to return useful summaries.

### Channel functions

* `ch_baseline`
* `ch_rereference`
* `chs_mean`

These functions act on the channels of the signal table. They have a default version that acts on all the channels, and can be used inside a `mutate` call for more control. (Not all of them support both actions right now, but they will be implemented in the near future).

### Other EEG-specialized functions

* `downsample`
* `segment`

* `event_to_ch_NA`

These functions perform specialized actions on the signals table or `eeg_lst`. (I may add a prefix to the functions when I see that I can group them).

### Plot functions

* `plot`
* `plot_gg`
* `plot_topo`

These functions do some data wrangling after summarizing or downsampling the signal to create a long table, and then wrap
`ggplot` functions.

### Base-inspired functions

* `as_*`
* `*_names`
* `is_*`
* `n*`
* `summary`

These functions should be straightforward to use, if one knows the parallel `base` function.



## Example



Here, I
exemplify the use of *eeguana* with (pre-processed) EEG data from BrainVision 2.0. The data belong to 
a simple experiment  where a
participant was presented 100 faces and 100 assorted images in random order. The
task of the experiment was to mentally count the number of faces.

First we download the data:

```{r downloading, eval = FALSE}
download.file("https://www.ling.uni-potsdam.de/~nicenboim/files/faces.vhdr", 
              "faces.vhdr", mode="wb")
download.file("https://www.ling.uni-potsdam.de/~nicenboim/files/faces.vmrk", 
              "faces.vmrk", mode="wb")
download.file("https://www.ling.uni-potsdam.de/~nicenboim/files/faces.dat", 
              "faces.dat", mode="wb")
```

BrainVision 2.0 exports three files: `faces.vhdr`, `faces.vmrk`, and
`faces.dat`. The file `faces.vhdr` contains the metadata and links to the other
two files, `faces.vmrk` contains the triggers and other events in the samples,
and `faces.dat` contains the signals at every sample for every channel recorded.


```{r libs, message = FALSE}
library(eeguana)
```

We first need to read the data:

```{r}
faces <- read_vhdr("faces.vhdr")
```

The function `read_vhdr` creates a list with data frames for the signal, events,
segments information, and incorporates in its attributes generic EEG information.

```{r}
faces
```

Some intervals were marked as "bad" by BrainVision, and so we'll remove them
from the data. We'll also segment and baseline the data. In this experiment, the
trigger "s70" was used for faces and "s71" for no faces. We'll segment the data
using these two triggers.

```{r}
faces_segs <- faces %>% 
               segment(description %in% c("s70", "s71"), 
                        lim = c(-.2,.25)) %>%
               event_to_ch_NA(type == "Bad Interval") %>% 
               ch_baseline()
```


We can also edit the segmentation information and add more descriptive labels.
*eeguana* has wrappers for many `dplyr` commands for the EEG data.  These commands always return an entire `eeg_lst` object so that they can be piped using `magrittr`'s pipe, `%>%`.

```{r}
faces_segs_some <- faces_segs %>%  
                  mutate(condition =
                  if_else(description == "s70", "faces", "non-faces")) %>% 
                  select(-type)

faces_segs_some
```

With some "regular" `ggplot` skills, we can create customized plots. `plot_gg`
downsamples the signals (by default), and converts them to a long-format data frame that is
feed into `ggplot` object. This object can then be customized. 

```{r plot, fig.dim = c(10,15), out.width = "100%", results = "hide"}
faces_segs_some %>% 
                  select(O1, O2, P7, P8) %>% 
                  plot_gg(faces_segs_some) + 
                  geom_line(alpha = .1, aes(group = .id, color = condition)) + 
                  stat_summary(fun.y = "mean", geom ="line", alpha = 1, size = 1.5, 
                  aes(color = condition)) +
                  facet_wrap(~ channel) + 
                  geom_vline(xintercept = 0, linetype = "dashed") + 
                geom_vline(xintercept = .17, linetype = "dotted") + 
                theme(legend.position = "bottom") 
```



Another possibility is to create a topographic plot of the two conditions, by
first making segments that include only the interval .1-.2 *s* after the onset
of the stimuli.

```{r topo, fig.dim = c(10,5), out.width = "100%", results = "hide"}
faces_segs_some %>% ungroup() %>%  
                    filter(between(as_time(.sample_id),.1,.2)) %>% 
                    group_by(condition) %>%
                    plot_topo()
```


## See also

Other packages for EEG/ERP data:

* [eegUtils](https://github.com/craddm/eegUtils ) some helper utilities for plotting and processing EEG data in active development by Matt Craddock.
* [erpR](https://cran.r-project.org/web/packages/erpR/index.html)  analysis of event-related potentials (ERPs) by Giorgio Arcara, Anna Petrova. It hasn't been updated since 2014.

